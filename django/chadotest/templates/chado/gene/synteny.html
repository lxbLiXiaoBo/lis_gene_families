{% extends 'chado/base.html' %}
{% load static %}
{% block css %}
<style>

#synteny {
	  font: 10px sans-serif;
}

.axis path,
.axis line {
	  fill: none;
	    stroke: #000;
		  shape-rendering: crispEdges;
}

.dot {
	  stroke: #000;
}

</style>
{% endblock %}
{% block content %}
<div class="page-header" id="banner">
    <div class="row">
        <div class="col-lg-12">
            <h1>Synteny Miner</h1>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-12">
        {% if messages %}
            {% for message in messages %}
            <div class="alert{% if message.tags %} alert-{{ message.tags }}{% endif %}">
                <strong>{{ message.tags|capfirst }}!</strong> {{ message }}
            </div>
            {% endfor %}
        {% endif %}
		<div id="synteny">
		</div>
    </div>
</div>
{% endblock %}
{% block javascript %}
<!--<script type="text/javascript" src="{% static 'js/jquery-1.10.2.min.js' %}"></script>-->
<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
<script type="text/javascript">

//$(document).ready(function() {
//	console.log("ready!");
//});

var json = '{{ json|safe }}';


var w = d3.max([1000,document.getElementById('synteny').offsetWidth]),
	p = 100,
	plots_per_row = 3,
	l = (w-(p*4))/plots_per_row;

var color = d3.scale.category10();

//d3.tsv("data.tsv", function(error, data) {
var data = JSON.parse(json);

var num_plots = data.plots.length,
	num_rows = Math.ceil(num_plots/plots_per_row),
	h = num_rows*l + (num_rows+1)*p;

var svg = d3.select("#synteny").append("svg")
    .attr("width", w )
    .attr("height", h )
  .append("g")
    .attr("transform", "translate(" + p + ",0)")
	.style("background-color", "black");

var i = 0;
data.plots.forEach(function(d) {

	var plot_x = ((i)%plots_per_row)*(p+l),
		plot_y = Math.ceil((i+1)/3)*(l+p);

	var min_x = d3.min(d.points, function(e) { return e.x; }),
		max_x = d3.max(d.points, function(e) { return e.x; });

	var x = d3.scale.linear()
		.domain([min_x, max_x])
	    .range([plot_x, plot_x+l]);
	
	var xAxis = d3.svg.axis()
	    .scale(x)
	    .orient("bottom")
		.tickValues([min_x, max_x]);

	svg.append("g")
	    .attr("class", "x axis")
	    .attr("transform", "translate(0," + plot_y + ")")
	    .call(xAxis)
	  .append("text")
	    .attr("class", "label")
	    .attr("x", (plot_x+(l/2)))
	    .attr("y", 10)
	    .style("text-anchor", "end")
	    .text(d.chromosome_name);

	var min_y = d3.min(d.points, function(e) { return e.y; }),
		max_y = d3.max(d.points, function(e) { return e.y; });

	var y = d3.scale.linear()
		.domain([min_y, max_y])
	    .range([plot_y, plot_y-l]);
	
	var yAxis = d3.svg.axis()
	    .scale(y)
	    .orient("left")
		.tickValues([min_y, max_y]);
	
	svg.append("g")
	    .attr("class", "y axis")
	    .attr("transform", "translate("+plot_x+", 0)")
	    .call(yAxis)
	  .append("text")
	    .attr("class", "label")
		.attr("transform", "translate(-10,"+(plot_y-(l/2))+") rotate(-90)")
	    //.attr("dy", ".71em")
	    .style("text-anchor", "end")
	    .text(data.query.chromosome_name);
	
	svg.selectAll(d.chromosome_name)
	    .data(d.points)
	  .enter().append("circle")
	    .attr("class", "dot")
	    .attr("r", 3.5)
	    .attr("cx", function(e) { return x(e.x); })
	    .attr("cy", function(e) { return y(e.y); })
	    .style("fill", function(e) { return color(e.family); });
//	
//	var legend = svg.selectAll(".legend")
//	    .data(color.domain())
//	  .enter().append("g")
//	    .attr("class", "legend")
//	    .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
//	
//	legend.append("rect")
//	    .attr("x", width - 18)
//	    .attr("width", 18)
//	    .attr("height", 18)
//	    .style("fill", color);
//	
//	legend.append("text")
//	    .attr("x", width - 24)
//	    .attr("y", 9)
//	    .attr("dy", ".35em")
//	    .style("text-anchor", "end")
//	    .text(function(d) { return d; });
//});

	i++;
});
</script>
{% endblock %}
